name: Actualizar noticias PortalPortuario (titulares)

on:
  workflow_dispatch:
    inputs:
      pages_branch:
        description: "Branch que publica GitHub Pages (ej: main, work)"
        required: false
        default: ""
  schedule:
    - cron: "0 12 * * *" # una vez al d√≠a (UTC)

permissions:
  contents: write

concurrency:
  group: news-fetch
  cancel-in-progress: true

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - name: Resolve Pages branch
        env:
          INPUT_BRANCH: ${{ github.event.inputs.pages_branch }}
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python - <<'PY'
          import json
          import os
          import urllib.request

          input_branch = (os.environ.get("INPUT_BRANCH") or "").strip()
          repo = os.environ["REPO"]
          token = os.environ["GH_TOKEN"]

          branch = input_branch
          if not branch:
              url = f"https://api.github.com/repos/{repo}/pages"
              req = urllib.request.Request(url, headers={"Authorization": f"Bearer {token}"})
              with urllib.request.urlopen(req) as response:
                  data = json.load(response)
              branch = data.get("source", {}).get("branch") or "main"

          with open(os.environ["GITHUB_ENV"], "a", encoding="utf-8") as env:
              env.write(f"PAGES_BRANCH={branch}\n")
          print(f"Using Pages branch: {branch}")
          PY

      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true
          ref: ${{ env.PAGES_BRANCH }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 lxml python-dateutil

      - name: Fetch titulares
        run: |
          python scripts/fetch_titulares.py

      - name: Commit changes if any
        run: |
          BRANCH_NAME="${PAGES_BRANCH}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add data/news.json
          if git diff --staged --quiet; then
            echo "No changes to commit."
            exit 0
          fi

          git commit -m "Update news.json (PortalPortuario)"
          git pull --rebase origin "${BRANCH_NAME}"
          git push origin "HEAD:${BRANCH_NAME}"
